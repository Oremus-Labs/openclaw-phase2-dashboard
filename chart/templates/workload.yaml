apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.namespace }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openclaw-ops-dashboard
  namespace: {{ .Values.namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: openclaw-ops-dashboard-read
rules:
  - apiGroups: [""]
    resources: ["pods","services","events","namespaces"]
    verbs: ["get","list","watch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get","list","watch"]
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get","list","watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: openclaw-ops-dashboard-read
subjects:
  - kind: ServiceAccount
    name: openclaw-ops-dashboard
    namespace: {{ .Values.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openclaw-ops-dashboard-read
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openclaw-ops-dashboard-app
  namespace: {{ .Values.namespace }}
data:
  server.js: |
    const http = require('http');
    const fs = require('fs');
    const path = require('path');

    const tokenPath = '/var/run/secrets/kubernetes.io/serviceaccount/token';
    const caPath = '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt';
    const token = fs.readFileSync(tokenPath, 'utf8');

    async function k8s(pathname) {
      const res = await fetch('https://kubernetes.default.svc' + pathname, {
        headers: { Authorization: `Bearer ${token}` },
        agent: undefined,
      });
      if (!res.ok) throw new Error(`k8s ${pathname} ${res.status}`);
      return await res.json();
    }

    function summarizeDeploy(items) {
      return items.map(d => ({
        name: d.metadata.name,
        ns: d.metadata.namespace,
        ready: `${d.status.readyReplicas || 0}/${d.status.replicas || 0}`,
        available: d.status.availableReplicas || 0,
      }));
    }

    const server = http.createServer(async (req, res) => {
      if (req.url === '/api/status') {
        try {
          const [workersDeploy, workersHpa, mainDeploy] = await Promise.all([
            k8s('/apis/apps/v1/namespaces/openclaw-workers/deployments'),
            k8s('/apis/autoscaling/v2/namespaces/openclaw-workers/horizontalpodautoscalers'),
            k8s('/apis/apps/v1/namespaces/openclaw/deployments'),
          ]);
          const payload = {
            generatedAt: new Date().toISOString(),
            workers: summarizeDeploy(workersDeploy.items || []),
            main: summarizeDeploy(mainDeploy.items || []),
            hpas: (workersHpa.items || []).map(h => ({ name: h.metadata.name, min: h.spec.minReplicas, max: h.spec.maxReplicas })),
            alerts: [],
          };
          const bad = payload.workers.filter(w => {
            const [r,t] = w.ready.split('/').map(Number);
            return t > 0 && r < t;
          });
          if (bad.length) payload.alerts.push({ level:'warn', text:`${bad.length} worker deployment(s) not fully ready` });
          res.writeHead(200, { 'content-type': 'application/json' });
          res.end(JSON.stringify(payload));
        } catch (e) {
          res.writeHead(500, { 'content-type': 'application/json' });
          res.end(JSON.stringify({ error: String(e) }));
        }
        return;
      }
      const p = path.join('/app', 'index.html');
      const html = fs.readFileSync(p, 'utf8');
      res.writeHead(200, { 'content-type': 'text/html; charset=utf-8' });
      res.end(html);
    });

    server.listen(8080, '0.0.0.0');
  index.html: |
    <!doctype html>
    <html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>OpenClaw Operations Center</title>
    <style>
      body{font-family:Inter,system-ui;background:#070b16;color:#eaf0ff;margin:0}.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
      .hero{background:linear-gradient(135deg,#2563eb,#7c3aed);padding:20px;border-radius:16px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:14px}
      .card{background:#101a33;border:1px solid #263a6b;border-radius:12px;padding:12px}.muted{color:#a7b8e8}.ok{color:#86efac}.warn{color:#fcd34d}
      table{width:100%;border-collapse:collapse}td,th{padding:8px;border-bottom:1px solid #263a6b;text-align:left}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:900px){.row{grid-template-columns:1fr}}
    </style></head>
    <body><div class="wrap">
      <div class="hero"><h1>OpenClaw Operations Center</h1><div class="muted">Live operations dashboard · private network deployment</div><div id="time" class="muted"></div></div>
      <div class="row" style="margin-top:12px">
        <div class="card"><h3>Main OpenClaw</h3><div id="main">Loading…</div></div>
        <div class="card"><h3>Worker Lanes</h3><div id="workers">Loading…</div></div>
      </div>
      <div class="grid">
        <div class="card"><h3>Autoscaling Policies</h3><div id="hpa">Loading…</div></div>
        <div class="card"><h3>Alerts</h3><div id="alerts">Loading…</div></div>
        <div class="card"><h3>Runbook</h3><ul><li>Local-first routing</li><li>OAuth fail-closed for premium</li><li>OpenRouter fallback guarded</li><li>Kill switch + Argo rollback</li></ul></div>
      </div>
    </div>
    <script>
      async function load(){
        const r=await fetch('/api/status'); const j=await r.json();
        document.getElementById('time').textContent='Updated: '+new Date(j.generatedAt).toLocaleString();
        document.getElementById('main').innerHTML=(j.main||[]).map(d=>`<div><b>${d.name}</b> <span class='ok'>${d.ready}</span></div>`).join('')||'No data';
        document.getElementById('workers').innerHTML=(j.workers||[]).map(d=>`<div><b>${d.name}</b> <span class='${d.ready.startsWith('0/')?'warn':'ok'}'>${d.ready}</span></div>`).join('')||'No data';
        document.getElementById('hpa').innerHTML='<table><tr><th>Name</th><th>Range</th></tr>'+(j.hpas||[]).map(h=>`<tr><td>${h.name}</td><td>${h.min}-${h.max}</td></tr>`).join('')+'</table>';
        document.getElementById('alerts').innerHTML=(j.alerts&&j.alerts.length)?j.alerts.map(a=>`<div class='warn'>• ${a.text}</div>`).join(''):'<div class="ok">No active alerts</div>';
      }
      load(); setInterval(load,15000);
    </script>
    </body></html>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw-ops-dashboard
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openclaw-ops-dashboard
  template:
    metadata:
      labels:
        app: openclaw-ops-dashboard
    spec:
      serviceAccountName: openclaw-ops-dashboard
      containers:
        - name: dashboard
          image: node:20-alpine
          command: ["node","/app/server.js"]
          env:
            - name: NODE_TLS_REJECT_UNAUTHORIZED
              value: "0"
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: app
              mountPath: /app/server.js
              subPath: server.js
            - name: app
              mountPath: /app/index.html
              subPath: index.html
      volumes:
        - name: app
          configMap:
            name: openclaw-ops-dashboard-app
---
apiVersion: v1
kind: Service
metadata:
  name: openclaw-ops-dashboard
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: openclaw-ops-dashboard
  ports:
    - port: {{ .Values.service.port }}
      targetPort: 8080
      protocol: TCP
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: openclaw-ops-dashboard
  namespace: {{ .Values.namespace }}
spec:
  entryPoints:
    - {{ .Values.ingress.entryPoint }}
  routes:
    - kind: Rule
      match: Host(`{{ .Values.ingress.host }}`)
      services:
        - name: openclaw-ops-dashboard
          port: {{ .Values.service.port }}
  tls:
    secretName: {{ .Values.ingress.tlsSecretName }}
